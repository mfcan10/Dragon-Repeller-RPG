(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))i(a);new MutationObserver(a=>{for(const l of a)if(l.type==="childList")for(const r of l.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function s(a){const l={};return a.integrity&&(l.integrity=a.integrity),a.referrerPolicy&&(l.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?l.credentials="include":a.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function i(a){if(a.ep)return;a.ep=!0;const l=s(a);fetch(a.href,l)}})();class A{constructor(){this.ctx=null,this.currentMusic=null,this.init()}init(){try{this.ctx=new(window.AudioContext||window.webkitAudioContext)}catch(e){console.error("Web Audio API not supported",e)}}resume(){this.ctx&&this.ctx.state==="suspended"&&this.ctx.resume()}createOscillator(e,s,i,a){if(!this.ctx)return null;const l=this.ctx.createOscillator(),r=this.ctx.createGain();return l.type=e,l.frequency.setValueAtTime(s,i),l.connect(r),r.connect(this.ctx.destination),{osc:l,gain:r}}playTone({freq:e,type:s="sine",duration:i=.1,vol:a=.1,slideTo:l=null}){if(!this.ctx)return;this.resume();const r=this.ctx.currentTime,{osc:c,gain:h}=this.createOscillator(s,e,r);h.gain.setValueAtTime(a,r),h.gain.exponentialRampToValueAtTime(.01,r+i),l&&c.frequency.exponentialRampToValueAtTime(l,r+i),c.start(r),c.stop(r+i)}playSwordSwing(){this.playTone({freq:200,slideTo:100,duration:.1,vol:.3})}playDaggerSwing(){this.playTone({freq:300,slideTo:150,duration:.08,vol:.25})}playHammerSwing(){this.playTone({freq:150,slideTo:80,duration:.15,vol:.4})}playSwordHit(){this.playTone({freq:400,type:"square",slideTo:200,duration:.2,vol:.3})}playDamage(){if(!this.ctx)return;this.resume();const e=this.ctx.currentTime,s=this.createOscillator("sawtooth",150,e);s.gain.gain.setValueAtTime(.4,e),s.gain.gain.exponentialRampToValueAtTime(.01,e+.3),s.osc.frequency.exponentialRampToValueAtTime(100,e+.3),s.osc.start(e),s.osc.stop(e+.3);const i=this.createOscillator("triangle",200,e);i.gain.gain.setValueAtTime(.4,e),i.gain.gain.exponentialRampToValueAtTime(.01,e+.3),i.osc.frequency.exponentialRampToValueAtTime(120,e+.3),i.osc.start(e),i.osc.stop(e+.3)}playWinMusic(){if(!this.ctx)return;this.stopMusic();const e=[{freq:523.25,time:0},{freq:659.25,time:.2},{freq:783.99,time:.4},{freq:1046.5,time:.6},{freq:783.99,time:.8},{freq:1046.5,time:1},{freq:1318.51,time:1.2},{freq:1567.98,time:1.4}];this.playSequence(e)}playLoseMusic(){if(!this.ctx)return;this.stopMusic();const e=[{freq:220,time:0,type:"sawtooth"},{freq:196,time:.3,type:"sawtooth"},{freq:174.61,time:.6,type:"sawtooth"},{freq:155.56,time:.9,type:"sawtooth"},{freq:146.83,time:1.2,type:"sawtooth"}];this.playSequence(e)}playSequence(e){e.forEach(s=>{setTimeout(()=>{this.playTone({freq:s.freq,type:s.type||"sine",duration:.3,vol:.2})},s.time*1e3)})}stopMusic(){this.currentMusic}}class E{constructor(){this.xp=0,this.health=100,this.gold=50,this.currentWeapon=0,this.inventory=["stick"],this.fighting=null,this.monsterHealth=0}reset(){this.xp=0,this.health=100,this.gold=50,this.currentWeapon=0,this.inventory=["stick"],this.fighting=null,this.monsterHealth=0}load(e){Object.assign(this,e)}serialize(){return{xp:this.xp,gold:this.gold,health:this.health,currentWeapon:this.currentWeapon,inventory:this.inventory}}}const n=new E,g="DRAGON_REPELLER_2024_SECURE_KEY",x={async save(o){try{const e=JSON.stringify(o),s=await C(e);return localStorage.setItem("dr_game_data",s),!0}catch(e){return console.error("Failed to save game:",e),!1}},async load(){try{const o=localStorage.getItem("dr_game_data");if(!o)return null;const e=await k(o);return e?JSON.parse(e):null}catch(o){return console.error("Failed to load game:",o),null}},reset(){localStorage.removeItem("dr_game_data")}};async function C(o){try{const e=new TextEncoder,s=e.encode(o),i=await crypto.subtle.importKey("raw",e.encode(g),{name:"PBKDF2"},!1,["deriveBits","deriveKey"]),a=crypto.getRandomValues(new Uint8Array(16)),l=await crypto.subtle.deriveKey({name:"PBKDF2",salt:a,iterations:1e5,hash:"SHA-256"},i,{name:"AES-GCM",length:256},!1,["encrypt"]),r=crypto.getRandomValues(new Uint8Array(12)),c=await crypto.subtle.encrypt({name:"AES-GCM",iv:r},l,s),h=new Uint8Array(a.length+r.length+c.byteLength);return h.set(a,0),h.set(r,a.length),h.set(new Uint8Array(c),a.length+r.length),btoa(String.fromCharCode(...h))}catch{return B(o)}}async function k(o){try{const e=new TextEncoder,s=new TextDecoder,i=Uint8Array.from(atob(o),f=>f.charCodeAt(0)),a=i.slice(0,16),l=i.slice(16,28),r=i.slice(28),c=await crypto.subtle.importKey("raw",e.encode(g),{name:"PBKDF2"},!1,["deriveBits","deriveKey"]),h=await crypto.subtle.deriveKey({name:"PBKDF2",salt:a,iterations:1e5,hash:"SHA-256"},c,{name:"AES-GCM",length:256},!1,["decrypt"]),p=await crypto.subtle.decrypt({name:"AES-GCM",iv:l},h,r);return s.decode(p)}catch{return H(o)}}function B(o){const e=g+"_X",s=Math.random().toString(36).substring(2,15);let i="";for(let a=0;a<o.length;a++){const l=o.charCodeAt(a),r=e.charCodeAt(a%e.length),c=s.charCodeAt(a%s.length),h=l^r^c;i+=String.fromCharCode(h)}return btoa(s+":"+i)}function H(o){try{const e=g+"_X",i=atob(o).split(":");if(i.length!==2)return null;const a=i[0],l=i[1];let r="";for(let c=0;c<l.length;c++){const h=l.charCodeAt(c),p=e.charCodeAt(c%e.length),f=a.charCodeAt(c%a.length),S=h^p^f;r+=String.fromCharCode(S)}return r}catch{return null}}class q{constructor(){this.elements={xpText:document.getElementById("xpText"),xpFill:document.getElementById("xpFill"),healthText:document.getElementById("healthText"),healthFill:document.getElementById("healthFill"),goldText:document.getElementById("goldText"),monsterStats:document.getElementById("monsterStats"),monsterName:document.getElementById("monsterName"),monsterHealth:document.getElementById("monsterHealth"),monsterHealthFill:document.getElementById("monsterHealthFill"),button1:document.getElementById("button1"),button2:document.getElementById("button2"),button3:document.getElementById("button3"),text:document.getElementById("text"),combatArea:document.getElementById("combatArea"),monsterImage:document.getElementById("monsterImage"),monsterNameDisplay:document.getElementById("monsterNameDisplay"),player:document.getElementById("player"),locationImage:document.getElementById("locationImage"),locationImageContainer:document.getElementById("locationImageContainer"),winOverlay:document.getElementById("winOverlay"),loseOverlay:document.getElementById("loseOverlay"),winMessage:document.getElementById("winMessage"),loseMessage:document.getElementById("loseMessage"),winRestart:document.getElementById("winRestart"),loseRestart:document.getElementById("loseRestart")},this.currentMonsterMaxHealth=100}updateStats(e){this.elements.xpText.innerText=e.xp,this.elements.healthText.innerText=e.health,this.elements.goldText.innerText=e.gold;const s=e.xp%100;this.elements.xpFill&&(this.elements.xpFill.style.width=`${s}%`);const i=Math.min(100,Math.max(0,e.health));this.elements.healthFill&&(this.elements.healthFill.style.width=`${i}%`,this.elements.healthFill.style.backgroundColor=e.health<30?"#ff4444":"#44ff44")}updateLocation(e,s){this.elements.text.innerText=e.text,this.elements.button1.innerText=e["button text"][0],this.elements.button2.innerText=e["button text"][1],this.elements.button3.innerText=e["button text"][2],this.elements.button1.onclick=s[0],this.elements.button2.onclick=s[1],this.elements.button3.onclick=s[2],this.elements.combatArea&&(this.elements.combatArea.style.display="none",this.elements.monsterStats.style.display="none"),this.elements.locationImage&&e.image&&(this.elements.locationImage.src=e.image,this.elements.locationImageContainer.className=e.imageClass||"",this.elements.locationImageContainer.style.display="flex")}showCombat(e){this.elements.monsterStats.style.display="flex",this.elements.combatArea.style.display="block",this.elements.locationImageContainer.style.display="none",this.elements.monsterName.innerText=e.name,this.elements.monsterHealth.innerText=`${e.health} / ${e.health}`,this.currentMonsterMaxHealth=e.health,this.updateMonsterHealth(e.health),this.elements.monsterImage.innerText=e.image,this.elements.monsterNameDisplay.innerText=e.name,this.elements.monsterImage.className=""}updateMonsterHealth(e){if(this.elements.monsterHealth.innerText=`${e} / ${this.currentMonsterMaxHealth}`,this.elements.monsterHealthFill){const s=e/this.currentMonsterMaxHealth*100;this.elements.monsterHealthFill.style.width=`${Math.max(0,s)}%`}}setMessage(e){this.elements.text.innerText=e}animatePlayerAttack(){this.elements.player.classList.add("player-attack"),setTimeout(()=>{this.elements.player.classList.remove("player-attack")},500)}animateMonsterHit(){this.elements.monsterImage.classList.add("monster-hit");const e=document.getElementById("game");e.classList.add("shake-screen"),setTimeout(()=>{this.elements.monsterImage.classList.remove("monster-hit"),e.classList.remove("shake-screen")},500)}animatePlayerHit(){this.elements.player.classList.add("player-hit"),document.body.classList.add("flash-red"),setTimeout(()=>{this.elements.player.classList.remove("player-hit"),document.body.classList.remove("flash-red")},500)}animatePlayerDodge(){this.elements.player.classList.add("player-dodge"),setTimeout(()=>{this.elements.player.classList.remove("player-dodge")},500)}animateMonsterAttack(){this.elements.monsterImage.classList.add("monster-attack"),setTimeout(()=>{this.elements.monsterImage.classList.remove("monster-attack")},500)}showWinOverlay(e){this.elements.winMessage.innerText=e,this.elements.winOverlay.classList.add("win-overlay-show")}showLoseOverlay(e){this.elements.loseMessage.innerText=e,this.elements.loseOverlay.classList.add("lose-overlay-show")}}const t=new q;class L{constructor(e,s,i){this.state=e,this.audio=s,this.ui=i}async attack(e,s){this.audio.resume(),this.audio.playSwordSwing(),this.ui.animatePlayerAttack(),await new Promise(c=>setTimeout(c,250)),this.ui.animateMonsterHit(),this.audio.playSwordHit();const i=Math.random()<.3;let a="";i?a=`The ${e.name} attacks, but you dodge it!`:a=`The ${e.name} attacks.`,a+=` You attack it with your ${s[this.state.currentWeapon].name}.`,this.ui.setMessage(a),await new Promise(c=>setTimeout(c,300)),i||(this.state.health-=e.level,this.ui.animatePlayerHit(),this.audio.playDamage());const r=s[this.state.currentWeapon].power+(this.state.currentWeapon>0?Math.floor(Math.random()*this.state.xp)+1:0);return this.state.monsterHealth-=r,{playerHealth:this.state.health,monsterHealth:this.state.monsterHealth,avoidDamage:i}}async dodge(e){this.audio.resume();const s=Math.random()<.6;return this.ui.animateMonsterAttack(),s?(this.ui.animatePlayerDodge(),this.ui.setMessage(`You successfully dodge the attack from the ${e.name}!`)):(this.ui.animatePlayerHit(),this.audio.playDamage(),this.state.health-=e.level,this.ui.setMessage(`You tried to dodge but failed! The ${e.name} hits you for ${e.level} damage.`)),{success:s,playerHealth:this.state.health}}}const y=new A,M=new L(n,y,t),u=[{name:"slime",level:2,health:15,image:"ðŸŸ¢"},{name:"fanged beast",level:8,health:60,image:"ðŸº"},{name:"dragon",level:20,health:300,image:"ðŸ‰"}],d=[{name:"stick",power:5},{name:"dagger",power:30},{name:"claw hammer",power:50},{name:"sword",power:100}],b=[{name:"town square","button text":["Go to store","Go to cave","Fight dragon"],"button functions":[O,D,G],text:"You are in the town square. You see a sign that says 'Town'.",image:"https://images.unsplash.com/photo-1515542622106-78bda8ba0e5b?w=800&h=600&fit=crop",imageClass:"town"},{name:"store","button text":["Buy 10 health (10 gold)","Buy weapon (30 gold)","Go to town square"],"button functions":[F,P,m],text:"You are in the store. You see a sign that says 'Store'.",image:"https://images.unsplash.com/photo-1708409858781-30df7a234f2d?w=800&h=600&fit=crop",imageClass:"store"},{name:"cave","button text":["Fight slime","Fight fanged beast","Go to town square"],"button functions":[W,Y,m],text:"You are in the cave. You see a sign that says 'Cave'.",image:"https://images.unsplash.com/photo-1517239320384-e08ad2c24a3e?w=800&h=600&fit=crop",imageClass:"cave"}];function T(o){t.updateLocation(o,o["button functions"])}function m(){T(b[0])}function O(){T(b[1])}function D(){T(b[2])}function F(){n.gold>=10?(n.gold-=10,n.health+=10,t.updateStats(n),t.setMessage("You bought 10 health for 10 gold.")):t.setMessage("You do not have enough gold to buy health.")}function P(){n.currentWeapon<d.length-1?n.gold>=30?(n.gold-=30,n.currentWeapon++,n.inventory.push(d[n.currentWeapon].name),t.updateStats(n),t.setMessage("You now have a "+d[n.currentWeapon].name+".")):t.setMessage("You do not have enough gold to buy a weapon."):(t.setMessage("You already have the best weapon!"),t.elements.button2.innerText="Sell weapon for 15 gold",t.elements.button2.onclick=R)}function R(){n.inventory.length>1&&(n.gold+=15,n.currentWeapon--,n.inventory.pop(),t.updateStats(n),t.setMessage("You sold a weapon for 15 gold."))}function W(){n.fighting=0,v()}function Y(){n.fighting=1,v()}function G(){n.fighting=2,v()}function v(){const o=u[n.fighting];n.monsterHealth=o.health,t.showCombat(o),t.setMessage("You are fighting a "+o.name+". What do you want to do?"),t.elements.button1.innerText="Attack",t.elements.button2.innerText="Dodge",t.elements.button3.innerText="Run",t.elements.button1.onclick=N,t.elements.button2.onclick=K,t.elements.button3.onclick=m}async function N(){const o=u[n.fighting];await M.attack(o,d),t.updateStats(n),t.updateMonsterHealth(n.monsterHealth),n.health<=0?I():n.monsterHealth<=0&&(n.fighting===2?_():V()),x.save(n.serialize())}async function K(){const o=u[n.fighting];await M.dodge(o),t.updateStats(n),n.health<=0&&I()}function V(){n.gold+=Math.floor(u[n.fighting].level*6.7),n.xp+=u[n.fighting].level,t.updateStats(n),t.setMessage('The monster screams "Arg!" as it dies. You gain experience points and find gold.'),t.elements.button1.innerText="Go to town square",t.elements.button2.innerText="Go to town square",t.elements.button3.innerText="Go to town square",t.elements.button1.onclick=m,t.elements.button2.onclick=m,t.elements.button3.onclick=m}function I(){t.updateStats(n),t.showLoseOverlay("You have died. The dragon reclaims the town."),y.playLoseMusic(),t.elements.button1.disabled=!0}function _(){t.updateStats(n),t.showWinOverlay("You defeat the dragon! THE TOWN IS SAVED!"),y.playWinMusic()}function w(){confirm("Are you sure you want to reset the game?")&&(x.reset(),n.reset(),t.updateStats(n),m(),t.elements.winOverlay.classList.remove("win-overlay-show"),t.elements.loseOverlay.classList.remove("lose-overlay-show"),t.elements.button1.disabled=!1)}async function $(){const o=await x.load();o&&n.load(o),t.updateStats(n),m(),document.getElementById("resetButton")&&(document.getElementById("resetButton").onclick=w),t.elements.winRestart&&(t.elements.winRestart.onclick=w),t.elements.loseRestart&&(t.elements.loseRestart.onclick=w),document.body.onclick=()=>{y.resume()}}$();
